<!DOCTYPE html>
<html lang="en">
<head> 
	<title></title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta http-equiv="language" content="de" />
	<meta name="author" content="" />
	<meta name="robots" content="index, follow" />
	<meta name="keywords" content="" />
    <meta name="description" content="" />

 	<meta name="viewport" content="width=device-width; initial-scale=1.0">

 	<link rel="shortcut icon" href="img/favicon.ico" />
 		
	<script src="http://www.google.com/jsapi?key=ABQIAAAA-aA-cQ-Dt_eOXMt2cABhzRQvRPGmAZu-tlfdhJELAgtO16tnWxRtu6M5pPKTlkg0fzoFpSutd24Z6A" type="text/javascript"></script>
	<!--
	Default: load JQuery from google library 
    http://code.google.com/intl/de-DE/apis/ajaxlibs/
    -->
    <script type="text/javascript">
  		google.load("jquery", "1");
  		google.load("jqueryui", "1");
	</script>

	<style>
		body { color:#FFFFFF; background:#666666; }
		canvas { background:#FFFFFF; margin-left:20%; }
		.counter { background:none; color:#0000FF; font-size:1.4em; border:0;}
	</style>

</head>
<body id="body">

Html5 / Javascript Jump&amp;Run game. <a href="http://www.weberdevelopment.de" target="_blank">weberdevelopment.de</a>
<p>Just for fun and learning experiences :) and not done yet !</p>
<p><strong>Instructions:</strong> Use your keyboard arrow keys !</p>

<script type="text/javascript">
		
		var canvas;
  		var context;

  		var HEIGHT;
  		var WIDTH;

  		var counter;
  		var hero;
  		var level;
  		var bg_cloud;
  		var skyscraper;

 		function Player() {

			this.width = 40;			
			this.height = 54;

			this.x = (canvas.width / 2) - (this.width / 2);
			this.y = canvas.height - this.height - 60;

			this.img = new Image();
  			this.img.src = "guy.png";

 			this.SPEED = 2;
 			this.levelSpeed = -2;

			this.jumpHeight = 110;
			this.halfPI = Math.PI / 2;
	    	/** The amount of time to spend in the air when jumping */
		    this.jumpHangTime = 0.5;
	        /** The speed to progress alone the sine wave that defines the jumping arc */
	        this.jumpSinWaveSpeed = this.halfPI / this.jumpHangTime;
	        /** The current position on the sine wave that defines the jump arc */
	        this.jumpSinWavePos = 0;
	        /** The rate to fall at */
	        this.fallMultiplyer = 1.5;
	        /** True when the player is on the ground, false otherwise */
	        this.grounded = true;
	        /** True if the player is moving left, false otherwise */
	        this.left = false;
	        /** True if the player is moving right, false otherwise */
	        this.right = false;
	        /** A reference to the level object */
	        this.level = null;

	        this.dt = 0.02;
	        this.fall = true;

          	this.blockGround = canvas.height;

	        // ------------------------------------------------------
	        this.draw = function() {

	        	// LEFT & RIGHT
		    	if (this.left) {
              		this.x -= this.SPEED;
              		this.img.src = "guyLeft.png";
              		this.levelSpeed = 0;
              	}
           		if (this.right) {
               		this.x += this.SPEED;
               		this.img.src = "guy.png";
               		this.levelSpeed = 0;
               	}

               	this.levelSpeed = -1;
		        
		        // JUMP
			  	if (!this.grounded)
		       	{
		            // the last position on the sine wave
		            var lastHeight = this.jumpSinWavePos;
		            // the new position on the sine wave
		            this.jumpSinWavePos += this.jumpSinWaveSpeed * this.dt;
		               
		            // we have fallen off the bottom of the sine wave, so continue falling
		            // at a predetermined speed
		            if (this.jumpSinWavePos >= Math.PI)
		        		this.y += this.jumpHeight / this.jumpHangTime * this.fallMultiplyer * this.dt;
		            // otherwise move along the sine wave
		            else
		            	this.y -= (Math.sin(this.jumpSinWavePos) - Math.sin(lastHeight)) * this.jumpHeight;
		           
			    	    // we have hit the ground
				        if (this.y + this.height >= this.blockGround) {
		               		this.y = this.blockGround - this.height;
		               		this.grounded = true;
		               		this.jumpSinWavePos = 0;
		           	}
		           	// otherwise we are falling
		           	else if (this.grounded) {		           			
		               		this.grounded = false;
		               		// starting falling down the sine wave (i.e. from the top)
		               		this.jumpSinWavePos = this.halfPI;
		           	}
           		}
	   			
	   			this.blockGround = canvas.height;
	   			
	   			// DRAW HERO
	   			if( this.x > 0) 
	   				this.x += this.levelSpeed;
	   			if( this.x < 0)
	   				this.x = 1;
	   			if( this.x > canvas.width)
	   				this.x = canvas.width - this.width;
	   			
	   			context.drawImage(this.img, this.x, this.y);
	   			// (image, sx, sy, sw, sh, dx, dy, dw, dh)
	   			
	        }
		}


		function Block(_x, _w, _h) {
			
			this.random = function( min, max ) {
				if( min > max ) {
					return( -1 );
				}
				if( min == max ) {
					return( min );
				}
 
       			return( min + parseInt( Math.random() * ( max-min+1 ) ) );
			}
			var rnd = this.random(0,4);
      		//var rnd2 = this.random(0,4);

			var blockWidths = [ 100, 150, 200, 300];
			var blockHeights = [ 20, 60, 100, 140 ];
			var blockColors = [ "#880000", "#008800", "#000088", "#880088" ];
			
		    this.color = blockColors[rnd];      
		    this.width = _w ? _w : blockWidths[rnd];		    
		    this.height = _h ? _h : blockHeights[rnd];
			
			this.x = _x;
			this.y = canvas.height - this.height;

			this.img = new Image();
      		this.img.src = "block300_100.png";

			this.speed = 2;

			this.draw = function(levelSpeed) {

				this.x -= this.speed + levelSpeed;
				//this.ctx.fillStyle = this.color;
				context.drawImage(this.img, this.x , this.y, this.width, this.height);
				//this.ctx.fillRect (this.x, this.y, this.width, this.height);

        		if(this.x + this.width < 0)
        			this.speed = 0;
        	}

		}


		function Level() {			

			this.lastBlock = null;
			this.blocks = new Array;

			this.hero = new Player(context, canvas);
			
			this.speed = 0.00001;
			const BLOCK_GAP = 160;
			const MAX_SPEED = 12;
			const ACCELERATION = 0.0001;

			// Generate first block:
			this.blocks.push(new Block(canvas.width / 2, 300, 60));

			this.generateBlock = function() {	
				
				if(this.blocks.length < 15) {
					var nextX = canvas.width;
					if(this.blocks.length > 0) {
						nextX = this.blocks[this.blocks.length - 1].x + this.blocks[this.blocks.length - 1].width + BLOCK_GAP;
					}
					this.blocks.push(new Block(nextX));					
				}
			}

			this.draw = function() {

        		
        		this.hero.draw();
				for(var i = 0; i < this.blocks.length; i++) {

					var blockXRange = this.blocks[i].x + this.blocks[i].width;	     	

			     	// Player hits ground
			        if(this.hero.y + this.hero.height == canvas.height)
			        	this.reset();

					// Draw Block
			     	if(blockXRange > 0) {
			     		
			     		if(this.speed < MAX_SPEED)
			     			this.speed += ACCELERATION;
						
						this.hero.levelSpeed = this.speed;

						// TODO: Only Draw blocks which are visible
						this.blocks[i].draw(this.speed);

					     		
			     		// Player between Block
						if( this.playerBetweenBlock(this.hero.x, this.hero.width, this.blocks[i].x, this.blocks[i].width) ) {
				     		// Player on Block
				     		this.hero.fall = false;
		     				this.hero.blockGround = canvas.height - this.blocks[i].height;
			     		} else {
			     			
			     		}			     	
			     		// Player in front of block
			     		/*if(this.playerToWall(this.blocks[i].x, this.blocks[i].y) )	{
			     			this.hero.x = this.block[i].x - this.hero.width;
			     			//this.hero.blockGround = canvas.height;
			     		}*/
			     		var nextBlock = this.nextBlock();
			     		if(nextBlock != null) {
			     			if(this.playerToWall(nextBlock.x, nextBlock.y)) {
			     				this.hero.x = nextBlock.x - this.hero.width;
			     				nextBlock.img.src = "blockNext.png";
			     				console.log("NEXT:" + nextBlock.x);
			     			}
			     		}


						// Player on ground
		     			if(this.hero.y + this.hero.height >= canvas.height - 5) {
		     				this.hero.y = -100;			     				
		     				this.reset();
						}

	
			     		// Player in Gap
			     		// TODO: GET NEXT BLOCK
			     		/*
			     		if( (this.hero.x + this.hero.width) < this.blocks[i].x && this.hero.x > blockXRange ) {
			     			this.hero.blockGround = canvas.height;

			     			// Player
			     			if((this.hero.y + this.hero.height <= this.blocks[i].y) && (this.hero.x + this.hero.width) >= this.blocks[i].x) {
			     			this.hero.y = canvas.height - this.hero.height;
			     			this.reset();
			     		} 
			     		}*/
					} else {
						// Delete if not visible anymore
						this.blocks.splice(i, 1);
					}
					
			     }			    			
			}      

			this.playerBetweenBlock = function(heroX, heroW, blockX, blockW) {
				if((heroX >= blockX) && (heroX + heroW <= blockX + blockW))
					return true;				
				else
					return false;			
			}

			this.playerToWall = function(blockX, blockY) {
				if(this.hero.x + this.hero.width >= blockX && this.hero.y >= blockY)
					return true;
				else
					return false;
			}

			this.nextBlock = function() {
				var nextBlocks = new Array();

				for(var i = 0; i < this.blocks.length; i++) {
					// GET ALL BLOCKS WHICH ARE COMING
					if( (this.hero.x + this.hero.width) < this.blocks[i].x) {						
						nextBlocks.push(this.blocks[i]);

					}
				}

				var min = canvas.width; 
				//console.log(nextBlocks.length);
				if(nextBlocks.length > 0) {
					min = nextBlocks[0].x;
					var nextBlock = null;

					// Get smallest x
					for(var i = 0; i < nextBlocks.length; i++) {
						if(nextBlocks[i].x < min) {
							min = nextBlocks[i].x;
							nextBlock = nextBlocks[i];
						}
					}

					return nextBlock;
				}
			}

			this.reset = function() {
				counter = document.getElementById("counter");
				counter.value = 0;
				this.speed = 0.00001;		
			}

		}
		
  		// --------------------------------------------------
  		function init() {
  			canvas = document.getElementById("canvas");
  			context = canvas.getContext("2d");

  			counter = document.getElementById("counter");
  			counter.value = 0;

  			context.font = "12pt Arial";

  			HEIGHT = canvas.height;
  			WIDTH = canvas.width;		

  			bg_cloud = new Image();
  			bg_cloud.src = "clouds.png";

  			skyscraper = new Image();
  			skyscraper.src = "skyscraper.png"

  			setInterval(draw, 15);
  			setInterval(generate, 500);
  		}


  		// --------------------------------------------------
  		function generate() {
  			level.generateBlock(); 

  			// SCORE
  			if(level.hero.y > 0)
  				counter.value = parseInt(counter.value) + 1; 			
  		}

  		var cloudMoveX = 0;
  		var skyScraperMoveX = 400;
  		function draw() {

  			context.clearRect(0, 0, WIDTH, HEIGHT); 	
  			
  			// Background
  			var gradient1 = context.createLinearGradient(0, 0, 0, 300);
  			gradient1.addColorStop(0,   '#c3d8ee');
			gradient1.addColorStop(1,   '#fff');
			context.fillStyle = gradient1;
			context.fillRect(0, 0, 600, 300);

  			// Clouds
  			cloudMoveX -= .1;
  			if(cloudMoveX <= -900.0) {
  				cloudMoveX = canvas.width;  				
  			}  			
  			context.drawImage(bg_cloud, cloudMoveX , 0);

  			// Skyscraper
  			skyScraperMoveX -= .9;
  			if(skyScraperMoveX <= -1200.0) {
  				skyScraperMoveX = canvas.width;
  			}
  			context.drawImage(skyscraper, skyScraperMoveX , 0);
  					
  			// Draw Level
  			level.draw();  			

  			//context.fillStyle = "#0000FF";
  			//context.fillText(counter.value, 5, 15);
  		}

  		// --------------------------------------------------
  		function onKeyDown(evt) {	
  			switch (evt.keyCode) {
  				case 39:    					
    					level.hero.right = true;
    					break;
  				case 37:
  						level.hero.left = true;
  						break;
  				case 38:
  						level.hero.grounded = false;
  						break;
  			}
		}
		
		function onKeyUp(evt) {
  			switch (evt.keyCode) {
  				case 39:
    					level.hero.right = false;
    					break;
  				case 37:
  						level.hero.left = false;
  						break;  				
  			}
		}

		// --------------------------------------------------
  		$(document).ready(function() {
  			init();
  			level = new Level();
  		});

  		$(document).keydown(onKeyDown);
		$(document).keyup(onKeyUp);

</script>

<div style="width:600px;margin-left:20%;">Score: <input size="4" type="text" id="counter" value="1" class="counter" readonly="readonly" /></div>
<canvas id="canvas" width="600" height="300">Your browser doesnt know html5 canvas	</canvas>

</body>
</html>